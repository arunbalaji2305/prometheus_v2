apiVersion: 1

groups:
  - orgId: 1
    name: System Alerts
    folder: NL2PromQL Alerts
    interval: 1m
    rules:
      # CPU Alerts
      - uid: cpu_high_usage
        title: High CPU Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 100 - (avg(rate(windows_cpu_time_total{mode="idle"}[5m])) * 100)
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 80
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: ""
              type: threshold
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: "CPU usage is above 80% (current: {{ $values.A.Value }}%)"
          summary: High CPU usage detected on {{ $labels.instance }}
        labels:
          severity: warning
          category: cpu

      - uid: cpu_critical_usage
        title: Critical CPU Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 100 - (avg(rate(windows_cpu_time_total{mode="idle"}[5m])) * 100)
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 95
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 2m
        annotations:
          description: "CPU usage is critically high at {{ $values.A.Value }}%"
          summary: CRITICAL - CPU usage on {{ $labels.instance }}
        labels:
          severity: critical
          category: cpu

      # Memory Alerts
      - uid: memory_high_usage
        title: High Memory Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 100 - ((windows_os_physical_memory_free_bytes / windows_cs_physical_memory_bytes) * 100)
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 85
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: "Memory usage is above 85% (current: {{ $values.A.Value }}%)"
          summary: High memory usage on {{ $labels.instance }}
        labels:
          severity: warning
          category: memory

      - uid: memory_critical_usage
        title: Critical Memory Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 100 - ((windows_os_physical_memory_free_bytes / windows_cs_physical_memory_bytes) * 100)
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 95
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 2m
        annotations:
          description: "Memory usage is critically high at {{ $values.A.Value }}%"
          summary: CRITICAL - Memory exhaustion on {{ $labels.instance }}
        labels:
          severity: critical
          category: memory

      # Disk Alerts
      - uid: disk_space_low
        title: Low Disk Space
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 100 - ((windows_logical_disk_free_bytes / windows_logical_disk_size_bytes) * 100)
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 80
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 10m
        annotations:
          description: "Disk usage on {{ $labels.volume }} is above 80% (current: {{ $values.A.Value }}%)"
          summary: Low disk space on {{ $labels.volume }}
        labels:
          severity: warning
          category: disk

      - uid: disk_space_critical
        title: Critical Disk Space
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: 100 - ((windows_logical_disk_free_bytes / windows_logical_disk_size_bytes) * 100)
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 90
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: "Disk {{ $labels.volume }} is almost full at {{ $values.A.Value }}%"
          summary: CRITICAL - Disk space on {{ $labels.volume }}
        labels:
          severity: critical
          category: disk

      # Network Alerts
      - uid: network_high_errors
        title: High Network Errors
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: rate(windows_net_packets_received_errors_total[5m]) + rate(windows_net_packets_outbound_errors_total[5m])
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 10
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
              refId: C
        noDataState: NoData
        execErrState: Error
        for: 5m
        annotations:
          description: "Network interface {{ $labels.nic }} has high error rate: {{ $values.A.Value }} errors/sec"
          summary: High network errors on {{ $labels.nic }}
        labels:
          severity: warning
          category: network

      # Service Down Alert
      - uid: service_down
        title: Service Down
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: up{job="windows Exporter"}
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: threshold
              refId: C
        noDataState: Alerting
        execErrState: Error
        for: 1m
        annotations:
          description: "Windows Exporter service on {{ $labels.instance }} is down"
          summary: Service {{ $labels.job }} is not responding
        labels:
          severity: critical
          category: system
